name: Check Caddy Releases and Trigger Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual triggering

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check_and_trigger:
    name: Check Caddy Release and Trigger Build if Needed
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check latest Caddy release and dispatch build (GHCR only)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const upstream = await github.rest.repos.getLatestRelease({ owner: "caddyserver", repo: "caddy" });
            const upstreamTag = upstream?.data?.tag_name || "";
            if (!upstreamTag) core.setFailed("Could not fetch latest Caddy release tag.");

            const normalized = upstreamTag.startsWith("v") ? upstreamTag.slice(1) : upstreamTag;
            core.info(`Latest upstream Caddy tag: ${upstreamTag} (normalized: ${normalized})`);

            // We use a GitHub Release in THIS repo (tag = normalized version, e.g. "2.11.0")
            // as the build marker. If it already exists, skip dispatch.
            let needsBuild = false;
            try {
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: normalized,
              });
              core.info(`Release '${normalized}' already exists in this repo; skipping dispatch.`);
            } catch (e) {
              if (e?.status === 404) {
                needsBuild = true;
                core.info(`Release '${normalized}' not found in this repo; dispatching build.`);
              } else {
                core.setFailed(`Failed checking release '${normalized}': ${e.message}`);
              }
            }

            if (!needsBuild) return;

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: "caddy-release",
              client_payload: {
                caddy_version: upstreamTag, // keep "v" prefix for clarity; build workflow normalizes
              },
            });
