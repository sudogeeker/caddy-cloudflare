name: Build and Push Standard Docker Image

on:
  repository_dispatch:
    types: [caddy-release]
  workflow_dispatch:
    inputs:
      build_version:
        description: 'Caddy version to build (without v prefix, e.g., 2.8.0)'
        required: false

permissions:
  contents: write
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Repository Owner and Name in Lowercase
        run: |
          REPO_OWNER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_OWNER=${REPO_OWNER}" >> $GITHUB_ENV
          REPO_NAME=$(echo "${GITHUB_REPOSITORY#*/}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_ENV

      - name: Resolve Caddy version (input/dispatch/latest)
        id: resolve_version
        uses: actions/github-script@v7
        with:
          script: |
            const inputVersion = context.payload?.inputs?.build_version;
            const dispatchVersion = context.payload?.client_payload?.caddy_version;
            let v = (inputVersion || dispatchVersion || "").toString().trim();
            if (!v) {
              core.info("No version provided. Fetching latest Caddy release...");
              const rel = await github.rest.repos.getLatestRelease({ owner: "caddyserver", repo: "caddy" });
              v = rel?.data?.tag_name || "";
            }
            if (!v) core.setFailed("Could not resolve Caddy version.");
            const normalized = v.startsWith("v") ? v.slice(1) : v;
            core.setOutput("version", normalized);

      - name: Set version env
        run: echo "VERSION=${{ steps.resolve_version.outputs.version }}" >> $GITHUB_ENV

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}
          tags: |
            # Raw version tags
            type=raw,value=${{ env.VERSION }}
            # Semver tagging strategy
            type=semver,pattern={{version}},value=${{ env.VERSION }}
            type=semver,pattern={{major}}.{{minor}},value=${{ env.VERSION }}
            type=semver,pattern={{major}},value=${{ env.VERSION }}
          labels: |
            org.opencontainers.image.title=Caddy Cloudflare
            org.opencontainers.image.description=Caddy with Cloudflare DNS module
            org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ env.VERSION }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.vendor=${{ github.repository_owner }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          build-args: |
            CADDY_VERSION=${{ env.VERSION }}
          platforms: linux/amd64,linux/arm64,linux/arm/v7,linux/ppc64le,linux/s390x
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: "Caddy v${{ env.VERSION }}"
          body: "New Caddy release detected. See the full release notes [here](https://github.com/caddyserver/caddy/releases/tag/v${{ env.VERSION }})."
          draft: false
          prerelease: false
